name: Auto Update Worker with Assets and Changelog
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç‰ˆæœ¬å¯¹æ¯”

      - name: æ¸…ç†å¯èƒ½å¹²æ‰°çš„ç¯å¢ƒå˜é‡
        run: |
          unset TAG_NAME
          unset DOWNLOAD_URL
          unset CHANGELOG

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          RELEASES_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
          RESPONSE=$(curl -s --retry 3 -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$RELEASES_URL")
          if [ $? -ne 0 ]; then
            echo "æ— æ³•è®¿é—®GitHub APIï¼Œé”™è¯¯ç  $?"
            exit 1
          fi
          STATUS_CODE=$(echo "$RESPONSE" | jq -r '.status')
          if [ "$STATUS_CODE" -ge 400 ]; then
            echo "APIå“åº”é”™è¯¯ï¼ŒçŠ¶æ€ç : $STATUS_CODE"
            exit 1
          fi
          export TAG_NAME=$(echo "$RESPONSE" | jq -r '.[0].tag_name')
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[0].assets[] | select(.name | endswith(".zip")) | .browser_download_url')
          export CHANGELOG=$(echo "$RESPONSE" | jq -r '.[0].body' | sed 's/[^\x00-\x7F]//g; s/\\//g; s/\"//g')

      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        run: |
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        run: |
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          SHOULD_UPDATE=true
          if [ "$FORCE_UPDATE" = "true" ]; then
            echo "éœ€è¦æ›´æ–°ï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰"
          else
            if [ "$LOCAL_VERSION" != "$TAG_NAME" ]; then
              echo "éœ€è¦æ›´æ–°ï¼ˆç‰ˆæœ¬ä¸åŒï¼‰"
            else
              echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
              SHOULD_UPDATE=false
            fi
          fi
          if [ "$SHOULD_UPDATE" = "false" ]; then
            exit 0
          fi
        id: need_update

      - name: åˆ›å»ºèµ„äº§å­˜æ”¾ç›®å½•
        if: steps.need_update.outcome == 'success'
        run: |
          mkdir -p æºç æœªæ··æ·† # åˆ›å»ºæ ¹ç›®å½•ä¸‹çš„â€œæºç æœªæ··æ·†â€æ–‡ä»¶å¤¹

      - name: ä¸‹è½½æœ€æ–°èµ„äº§æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•
        if: steps.need_update.outcome == 'success'
        run: |
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [ -z "$DOWNLOAD_URL" ]; then
              echo "ä¸‹è½½é“¾æ¥ä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½"
              exit 1
            fi
            # ä¸‹è½½åˆ°â€œæºç æœªæ··æ·†â€ç›®å½•å¹¶å‘½åä¸ºæœ€æ–°ç‰ˆæœ¬å·.zip
            wget -q -O æºç æœªæ··æ·†/${TAG_NAME}.zip $DOWNLOAD_URL
            if [ $? -eq 0 ]; then
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "èµ„äº§æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
            exit 1
          fi
          echo "âœ… å·²ä¸‹è½½èµ„äº§åˆ°æºç æœªæ··æ·†ç›®å½•: ${TAG_NAME}.zip"

      - name: å¤„ç†ä¸»é¡µå†…å®¹ï¼ˆå¯é€‰ï¼šå¦‚éœ€è§£å‹èµ„äº§è¯·å–æ¶ˆæ³¨é‡Šï¼‰
        # if: steps.need_update.outcome == 'success'
        # run: |
        #   unzip -o æºç æœªæ··æ·†/${TAG_NAME}.zip -d æºç æœªæ··æ·†/
        #   rm æºç æœªæ··æ·†/${TAG_NAME}.zip
        #   echo "âœ… å·²è§£å‹èµ„äº§åˆ°æºç æœªæ··æ·†ç›®å½•"

      - name: æ•´åˆä¸»é¡µæ—¥å¿—
        if: steps.need_update.outcome == 'success'
        run: |
          RELEASE_CONTENT=$(cat RELEASE.md 2>/dev/null || echo "")
          CURRENT_LOG_CONTENT=$(cat homepage_log.txt 2>/dev/null || echo "")
          COMBINED_CONTENT="$RELEASE_CONTENT\n\n## ğŸ“¦ æœ€æ–°èµ„äº§æ›´æ–°\nç‰ˆæœ¬: $TAG_NAME\nèµ„äº§æ–‡ä»¶: ${TAG_NAME}.zip\n\n$CURRENT_LOG_CONTENT"
          echo -e "$COMBINED_CONTENT" > README.md

      - name: ä¿å­˜æ›´æ–°æ—¥å¿—
        if: steps.need_update.outcome == 'success'
        run: |
          echo "${CHANGELOG}" | tee -a -i - encoding=utf-8 changelog.txt >/dev/null

      - name: æ›´æ–°ç‰ˆæœ¬å·
        if: steps.need_update.outcome == 'success'
        run: |
          echo "$TAG_NAME" > version.txt

      - name: æäº¤æ›´æ–°
        if: steps.need_update.outcome == 'success'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ”„ åŒæ­¥ ${TAG_NAME} èµ„äº§åˆ°æºç æœªæ··æ·†ç›®å½•"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: main
          files: |
            æºç æœªæ··æ·†/
            README.md
            version.txt
            changelog.txt
